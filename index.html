<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Masalah Barang (Supabase)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            /* bg-slate-50 */
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
            /* Tambahkan untuk scrollbar horizontal */
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #aab2c0;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        /* Style for preventing background scroll when modal is open */
        .modal-open {
            overflow: hidden;
        }

        /* Menu Sidebar Styles */
        #menu-sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }

        #menu-sidebar.open {
            transform: translateX(0);
        }

        #menu-overlay {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
        }

        #menu-overlay.opacity-100 {
            opacity: 1;
        }

        /* Loading Spinner */
        .spinner {
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-top: 5px solid #6366f1;
            /* warna ungu lembut */
            border-radius: 50%;
            width: 45px;
            height: 45px;
            animation: spin 1s linear infinite;
        }


        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* --- CSS BARU UNTUK DOTS --- */
        /* Sembunyikan scrollbar di search-result */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
            /* Safari and Chrome */
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        /* Styling untuk dot navigasi */
        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #cbd5e1;
            /* bg-slate-300 */
            transition: all 0.3s;
            cursor: pointer;
        }

        .dot.active {
            background-color: #6366f1;
            /* bg-indigo-500 */
            transform: scale(1.2);
        }



        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .animate-pop-in {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* --- BLOB ANIMATION (New) --- */
        @keyframes blob {
            0% {
                transform: translate(0px, 0px) scale(1);
            }

            33% {
                transform: translate(30px, -50px) scale(1.1);
            }

            66% {
                transform: translate(-20px, 20px) scale(0.9);
            }

            100% {
                transform: translate(0px, 0px) scale(1);
            }
        }

        .animate-blob {
            animation: blob 7s infinite;
        }

        .animation-delay-2000 {
            animation-delay: 2s;
        }

        .animation-delay-4000 {
            animation-delay: 4s;
        }

        /* --- AKHIR CSS BARU --- */
    </style>
</head>

<body class="bg-slate-100 text-slate-800">

    <!-- Global Hamburger Button (Hidden in Operator View, shown in Admin) -->
    <button id="menu-btn-global-admin"
        class="hidden fixed top-4 left-4 sm:top-6 sm:left-6 p-3 rounded-xl text-slate-500 hover:text-slate-800 hover:bg-slate-100 z-40 transition-all bg-white shadow-xl shadow-slate-200/50 border border-slate-100 active:scale-90">
        <i class="fa-solid fa-bars text-xl"></i>
    </button>

    <!-- Menu Sidebar -->
    <div id="menu-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"></div>
    <div id="menu-sidebar"
        class="fixed top-0 left-0 w-64 h-full bg-slate-900 text-white shadow-lg z-50 p-6 flex flex-col">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-xl font-bold text-white">Menu</h2>
            <button id="close-menu-btn" class="p-1 rounded-full hover:bg-slate-700 text-slate-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <nav>
            <ul>
                <li>
                    <a href="#" id="menu-home-btn"
                        class="flex items-center space-x-3 px-3 py-3 rounded-lg text-slate-300 hover:bg-indigo-600 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                        <span>Home</span>
                    </a>
                </li>
                <li>
                    <a href="#" id="menu-admin-btn"
                        class="flex items-center space-x-3 px-3 py-3 rounded-lg text-slate-300 hover:bg-indigo-600 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span>Login Admin</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="mt-auto">
            <p id="connection-status" class="text-xs text-slate-400">Menghubungkan...</p>
        </div>
    </div>

    <div id="app" class="min-h-screen flex flex-col items-center p-2 sm:p-4 pt-4 sm:pt-6">

        <!-- Role Selection View (Hidden by default now) -->
        <div id="role-selection-view" class="hidden w-full max-w-md text-center p-4">
            <div class="bg-white p-6 sm:p-10 rounded-2xl shadow-2xl">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTo8y1TczYtwOx2zeS3RJVtM6Eayy6CQZuf6Q&s"
                    alt="Logo Shinpo" class="mx-auto mb-6 h-20 w-auto"
                    onerror="this.src='https://placehold.co/100x100/e2e8f0/64748b?text=Logo'; this.onerror=null;">
                <h1 class="text-3xl md:text-4xl font-extrabold text-slate-900 mb-2">Sistem Inventaris</h1>
                <p class="text-slate-500 mb-8 text-lg">Silakan pilih peran Anda.</p>
                <div class="space-y-4">
                    <button id="admin-role-btn"
                        class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105">Masuk
                        sebagai Admin</button>
                    <button id="operator-role-btn"
                        class="w-full bg-slate-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700 transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105">Masuk
                        sebagai Operator</button>
                </div>
            </div>
        </div>

        <!-- Admin View -->
        <div id="admin-view" class="hidden w-full max-w-6xl mx-auto p-2 sm:p-4 md:p-6">
            <!-- Hero Section (Admin) -->
            <div class="relative w-full flex flex-col items-center mb-8 pt-2">
                <!-- Background Blobs -->
                <div
                    class="absolute top-0 left-1/2 -translate-x-1/2 w-[120%] h-full max-w-5xl overflow-visible -z-0 pointer-events-none">
                    <div
                        class="absolute top-0 left-20 w-72 h-72 bg-blue-300/30 rounded-full blur-[60px] animate-blob mix-blend-multiply filter opacity-70">
                    </div>
                    <div
                        class="absolute top-10 right-20 w-72 h-72 bg-indigo-300/30 rounded-full blur-[60px] animate-blob animation-delay-2000 mix-blend-multiply filter opacity-70">
                    </div>
                    <div
                        class="absolute -bottom-10 left-1/2 -translate-x-1/2 w-64 h-64 bg-cyan-300/30 rounded-full blur-[60px] animate-blob animation-delay-4000 mix-blend-multiply filter opacity-70">
                    </div>
                </div>

                <!-- Glass Header -->
                <div
                    class="relative z-10 w-full flex items-center justify-between px-4 sm:px-8 py-4 bg-white/60 backdrop-blur-xl rounded-[2rem] border border-white/60 shadow-lg shadow-indigo-100/20 mb-8 transition-all hover:shadow-indigo-100/40">
                    <!-- Left: Spacer for balance -->
                    <div class="w-10 sm:w-32 hidden sm:block"></div>

                    <!-- Center: Title -->
                    <h1
                        class="text-xl sm:text-3xl font-black text-slate-800 tracking-tight uppercase flex-1 text-center whitespace-nowrap">
                        Dashboard <span class="text-indigo-600">Admin</span>
                    </h1>

                    <!-- Right: Actions -->
                    <div class="flex items-center gap-2 sm:w-32 justify-end">
                        <button id="tracking-btn-admin"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-4 rounded-xl shadow-md hover:shadow-indigo-200 transition-all active:scale-95 flex items-center gap-2 text-sm group">
                            <i class="fa-solid fa-users group-hover:scale-110 transition-transform"></i>
                            <span class="hidden sm:inline">Pengunjung</span>
                        </button>
                        <button id="admin-logout-btn"
                            class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2.5 px-4 rounded-xl shadow-md hover:shadow-rose-200 transition-all active:scale-95 text-sm group">
                            <span class="hidden sm:inline">Keluar</span>
                            <i class="fa-solid fa-power-off sm:hidden group-hover:scale-110 transition-transform"></i>
                        </button>
                    </div>
                </div>

                <!-- 'Tambah Data' Button & Stats -->
                <div class="relative z-10 w-full flex items-center justify-between px-2">
                    <button id="toggle-form-btn"
                        class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-all shadow-md hover:shadow-lg flex items-center gap-2 group active:scale-95 transform hover:-translate-y-0.5 text-xs">
                        <div class="bg-white/20 rounded-md p-0.5 backdrop-blur-sm">
                            <i id="toggle-form-icon"
                                class="fa-solid fa-plus text-white text-[10px] transition-transform duration-300 group-hover:rotate-90"></i>
                        </div>
                        <span id="toggle-form-text" class="tracking-wide">Tambah Data Barang</span>
                    </button>

                    <!-- Stats Card -->
                    <div
                        class="bg-white/60 backdrop-blur-xl px-4 py-2 rounded-2xl border border-white/60 shadow-lg shadow-indigo-100/10 flex items-center gap-3 transition-all hover:shadow-indigo-100/20">
                        <div
                            class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl flex items-center justify-center text-white shadow-sm">
                            <i class="fa-solid fa-boxes-stacked text-[10px]"></i>
                        </div>
                        <div>
                            <p
                                class="text-[8px] font-black text-slate-400 uppercase tracking-[0.2em] leading-none mb-1">
                                Total Kode</p>
                            <p id="total-items-count" class="text-sm font-black text-slate-800 leading-none">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form for adding/editing items -->
            <div id="admin-form-container"
                class="hidden bg-white p-4 sm:p-8 rounded-2xl shadow-xl mb-8 border border-slate-200 animate-fade-in">
                <h2 id="form-title" class="text-2xl font-bold text-slate-800 mb-6">Tambah Barang Baru</h2>
                <form id="item-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <input type="hidden" id="item-id">
                    <div>
                        <label for="kode-barang" class="block text-sm font-medium text-slate-700 mb-2">Kode
                            Barang</label>
                        <input type="text" id="kode-barang" required
                            class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition focus:bg-slate-50 uppercase">
                    </div>
                    <div>
                        <label for="nama-barang" class="block text-sm font-medium text-slate-700 mb-2">Nama
                            Barang</label>
                        <input type="text" id="nama-barang" required
                            class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition focus:bg-slate-50 uppercase">
                    </div>
                    <div class="md:col-span-2">
                        <label for="permasalahan"
                            class="block text-sm font-medium text-slate-700 mb-2">Permasalahan</label>
                        <textarea id="permasalahan" rows="4" required
                            class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition focus:bg-slate-50 uppercase"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label for="gambar-barang" class="block text-sm font-medium text-slate-700 mb-2">Gambar
                            Barang</label>
                        <input type="file" id="gambar-barang" accept="image/*"
                            class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition-colors">
                        <img id="image-preview" src="" alt="Pratinjau Gambar"
                            class="hidden mt-4 max-h-40 rounded-lg border border-slate-200 p-1" />
                    </div>
                    <div class="md:col-span-2 flex justify-end space-x-3">
                        <button type="button" id="cancel-edit-btn"
                            class="hidden bg-slate-200 text-slate-700 font-bold py-3 px-6 rounded-lg hover:bg-slate-300 transition-colors">Batal</button>
                        <button type="submit" id="submit-btn"
                            class="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors shadow-md hover:shadow-lg">Simpan</button>
                    </div>
                </form>
            </div>

            <!-- List of items: Desain Container Lebih Elegan -->
            <div id="item-list-container"
                class="bg-white rounded-[2.5rem] shadow-2xl shadow-indigo-100/50 border border-slate-100 p-8 sm:p-12 overflow-hidden relative">
                <!-- Dekorasi Background -->
                <div
                    class="absolute top-0 right-0 -mr-20 -mt-20 w-64 h-64 bg-indigo-50 rounded-full blur-3xl opacity-60">
                </div>
                <div
                    class="absolute bottom-0 left-0 -ml-20 -mb-20 w-64 h-64 bg-rose-50 rounded-full blur-3xl opacity-60">
                </div>

                <div class="relative">
                    <div class="flex flex-col items-center mb-10">
                        <span
                            class="text-indigo-600 font-extrabold text-[9px] uppercase tracking-[0.4em] mb-2 opacity-70">Inventory
                            System</span>
                        <h2 class="text-xl sm:text-2xl font-black text-slate-800 tracking-tight text-center uppercase">
                            MASALAH <span class="text-indigo-600">BARANG</span>
                        </h2>
                        <div class="w-8 h-1 bg-indigo-600 rounded-full mt-3 mb-4 shadow-lg shadow-indigo-100"></div>

                        <!-- Tombol Toggle (Dipindah ke Atas) -->
                        <div class="mb-8">
                            <button id="toggle-admin-items-btn"
                                class="flex items-center gap-2 px-6 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-700 text-white font-black text-[9px] uppercase tracking-[0.2em] transition-all group active:scale-95 border border-transparent shadow-lg shadow-indigo-100">
                                <i id="toggle-admin-items-icon"
                                    class="fa-solid fa-eye transition-transform group-hover:scale-110"></i>
                                <span id="toggle-admin-items-text">Tampilkan Daftar</span>
                            </button>
                        </div>
                    </div>

                    <div id="admin-items-content" class="hidden w-full transition-all duration-500">
                        <!-- Search Bar Admin -->
                        <div class="w-full max-w-xl mx-auto mb-10">
                            <div class="relative group">
                                <div
                                    class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none transition-colors group-focus-within:text-indigo-600 text-slate-400">
                                    <i class="fa-solid fa-magnifying-glass text-sm"></i>
                                </div>
                                <input type="text" id="search-input-admin"
                                    class="w-full pl-12 pr-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 focus:bg-white transition-all outline-none font-bold text-slate-700 placeholder:text-slate-400 placeholder:font-medium"
                                    placeholder="Cari berdasarkan kode atau nama barang...">
                                <div id="search-clear-admin"
                                    class="hidden absolute inset-y-0 right-0 pr-5 flex items-center cursor-pointer text-slate-300 hover:text-rose-500 transition-colors">
                                    <i class="fa-solid fa-circle-xmark"></i>
                                </div>
                            </div>
                        </div>

                        <div id="item-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            <!-- Item cards will be injected here -->
                            <div id="loading-spinner-admin"
                                class="md:col-span-2 lg:col-span-3 text-center py-12 flex flex-col items-center">
                                <div class="spinner mb-4 shadow-lg shadow-indigo-100"></div>
                                <p class="text-slate-500 font-medium italic">Sinkronisasi data...</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <!-- AKHIR BAGIAN PENGGANTIAN -->

    </div>

    <!-- Operator View -->
    <div id="operator-view" class="hidden w-full max-w-6xl mx-auto p-2 sm:p-4 md:p-6">
        <!-- Hero Wrapper with Animated Background -->
        <div class="relative w-full flex flex-col items-center mb-10 pt-2">
            <!-- Background Animation Elements (Premium & Subtle) -->
            <div
                class="absolute top-0 left-1/2 -translate-x-1/2 w-[120%] h-full max-w-5xl overflow-visible -z-0 pointer-events-none">
                <div
                    class="absolute top-10 left-10 w-72 h-72 bg-indigo-300/30 rounded-full blur-[60px] animate-blob mix-blend-multiply filter opacity-70">
                </div>
                <div
                    class="absolute top-10 right-10 w-72 h-72 bg-purple-300/30 rounded-full blur-[60px] animate-blob animation-delay-2000 mix-blend-multiply filter opacity-70">
                </div>
                <div
                    class="absolute -bottom-8 left-1/2 -translate-x-1/2 w-72 h-72 bg-pink-300/30 rounded-full blur-[60px] animate-blob animation-delay-4000 mix-blend-multiply filter opacity-70">
                </div>
            </div>

            <!-- Header Baru: Sejajar & Elegan (z-10 added) -->
            <div
                class="relative z-10 flex items-center justify-between gap-1 sm:gap-4 mb-8 w-full max-w-4xl mx-auto px-2 sm:px-6 bg-white/60 backdrop-blur-xl py-4 rounded-[2rem] border border-white/60 shadow-lg shadow-indigo-100/20 mt-2">
                <!-- Hamburger Menu Sejajar -->
                <button id="menu-btn-operator"
                    class="p-3 sm:p-4 rounded-2xl text-slate-500 hover:text-indigo-600 hover:bg-white/80 transition-all active:scale-90 flex-shrink-0">
                    <i class="fa-solid fa-bars-staggered text-xl"></i>
                </button>

                <!-- Judul Terpusat -->
                <div class="text-center flex-1 px-2 sm:px-4 min-w-0">
                    <h1
                        class="text-[15px] xs:text-lg sm:text-2xl font-black text-slate-900 tracking-tighter uppercase whitespace-nowrap leading-none mb-1">
                        PERMASALAHAN BARANG</h1>
                    <p
                        class="text-slate-500 text-[7px] sm:text-[10px] font-extrabold uppercase tracking-[0.2em] whitespace-nowrap">
                        Sistem Monitoring Terpadu</p>
                </div>

                <!-- Right Actions Group -->
                <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
                    <!-- Refresh Button Sejajar (Elegant Design) -->
                    <button id="operator-refresh-btn"
                        class="p-2 sm:p-4 rounded-xl sm:rounded-2xl text-slate-500 hover:text-amber-600 hover:bg-white/80 transition-all active:scale-90 group">
                        <i
                            class="fa-solid fa-rotate text-base sm:text-xl group-hover:rotate-180 transition-transform duration-500"></i>
                    </button>
                </div>
            </div>

            <!-- Search Section: Premium Floating Bar (z-10 added) -->
            <div
                class="relative z-10 w-full max-w-lg mx-auto bg-white/80 backdrop-blur-md p-1.5 rounded-[2rem] shadow-xl shadow-indigo-200/40 border border-white/60 transition-all hover:shadow-indigo-200/60 hover:scale-[1.01]">
                <div class="flex items-center gap-1.5 p-1 sm:p-1.5">
                    <!-- Bagian Tengah: Input Field -->
                    <div class="relative flex-1">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 sm:pl-4 pointer-events-none">
                            <span
                                class="text-[8px] sm:text-[9px] font-black bg-slate-100 px-1.5 py-0.5 rounded-md text-slate-500 border border-slate-200/50 tracking-tighter uppercase whitespace-nowrap">Kode</span>
                        </div>
                        <input type="text" id="search-input" placeholder="Cari Masalah Barang..."
                            class="w-full pl-12 sm:pl-16 pr-3 py-2.5 sm:py-3 bg-transparent border-none focus:ring-0 outline-none uppercase font-bold text-slate-700 placeholder-slate-400 text-xs sm:text-sm">
                    </div>

                    <!-- Bagian Kanan: Tombol Cari -->
                    <button id="search-btn"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-black py-2.5 sm:py-3 px-4 sm:px-8 rounded-2xl shadow-lg shadow-indigo-300 transition-all active:scale-90 flex items-center gap-2 text-xs group shrink-0">
                        <span class="hidden xs:inline">CARI</span>
                        <i
                            class="fa-solid fa-arrow-right text-[10px] group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Search Result -->
        <!-- PERUBAHAN: Tambahkan class 'no-scrollbar' dan ubah margin bottom -->
        <div id="search-result"
            class="hidden mb-4 flex overflow-x-auto space-x-4 pb-4 md:block md:overflow-x-visible md:space-x-0 md:pb-0 no-scrollbar">
            <!-- Hasil pencarian akan muncul di sini -->
        </div>

        <!-- DIV BARU: Untuk Dot Navigasi -->
        <div id="search-dots" class="hidden justify-center space-x-2 mb-10 md:hidden">
            <!-- Dots akan di-generate oleh JS -->
        </div>


        <!-- Operator Item List: Desain Premium -->
        <section id="operator-item-list-container"
            class="bg-white rounded-t-[3rem] sm:rounded-[3rem] shadow-2xl shadow-indigo-100/50 border border-slate-100 p-8 sm:p-12 mt-2 overflow-hidden relative">
            <!-- Dekorasi Background -->
            <div class="absolute top-0 right-0 -mr-20 -mt-20 w-64 h-64 bg-indigo-50 rounded-full blur-3xl opacity-60">
            </div>

            <div class="relative">
                <div id="toggle-operator-list" class="flex flex-col items-center mb-8 cursor-pointer group select-none">
                    <span
                        class="text-indigo-600 font-black text-[8px] uppercase tracking-[0.4em] mb-2 opacity-70">Monitoring
                        Panel</span>
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl sm:text-2xl font-black text-slate-900 tracking-tight text-center uppercase">
                            DAFTAR <span class="text-indigo-600">MASALAH</span>
                        </h2>
                        <i id="toggle-icon-operator"
                            class="fa-solid fa-chevron-down text-slate-300 transition-transform duration-300 group-hover:text-indigo-500"></i>
                    </div>
                    <div class="w-8 h-1 bg-indigo-600 rounded-full mt-3 shadow-lg shadow-indigo-100"></div>
                    <p id="toggle-hint-operator"
                        class="text-slate-400 text-[9px] font-bold uppercase tracking-[0.2em] mt-4 group-hover:text-indigo-500 transition-colors flex items-center gap-2">
                        <span>Klik untuk melihat semua data</span>
                        <i class="fa-solid fa-arrow-pointer animate-bounce text-[10px]"></i>
                    </p>
                </div>

                <div id="operator-item-list-wrapper" class="hidden animate-fade-in">
                    <div id="operator-item-list"
                        class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6 sm:gap-8">
                        <div id="loading-spinner-operator"
                            class="col-span-full text-center py-16 flex flex-col items-center animate-fade-in">
                            <div class="spinner mb-5 shadow-inner"></div>
                            <p class="text-slate-500 font-medium italic">Mengambil data terbaru...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    </div> <!-- End of #app -->

    <!-- Image Zoom Modal -->
    <div id="image-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="relative bg-white p-4 rounded-xl shadow-2xl max-w-4xl max-h-[90vh] overflow-auto">
            <button id="close-modal-btn"
                class="absolute top-4 right-4 bg-white/80 backdrop-blur-md rounded-full p-2 text-slate-600 hover:text-rose-600 hover:bg-white z-20 shadow-xl border border-slate-100 transition-all active:scale-90">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <img id="modal-img" src="" alt="Detail Gambar Barang"
                class="w-auto h-auto max-w-full max-h-[80vh] object-contain rounded-lg">
            <div
                class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2 bg-black bg-opacity-50 p-2 rounded-lg">
                <button id="zoom-in-btn" class="text-white p-2 rounded-full hover:bg-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        <line x1="11" y1="8" x2="11" y2="14"></line>
                        <line x1="8" y1="11" x2="14" y2="11"></line>
                    </svg>
                </button>
                <button id="zoom-out-btn" class="text-white p-2 rounded-full hover:bg-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        <line x1="8" y1="11" x2="14" y2="11"></line>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Confirm Modal: Elegant & Premium Redesign -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-[100] transition-all duration-300">
        <!-- Backdrop with Blur -->
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>

        <!-- Modal Content -->
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div
                class="bg-white w-full max-w-[340px] rounded-[3rem] shadow-[0_25px_50px_-12px_rgba(0,0,0,0.25)] border border-white/40 overflow-hidden transform transition-all animate-pop-in">
                <!-- Header with Icon -->
                <div id="confirm-header" class="h-32 bg-indigo-600 relative flex items-center justify-center">
                    <!-- Icon Box -->
                    <div
                        class="relative w-16 h-16 bg-white/20 backdrop-blur-xl rounded-2xl flex items-center justify-center text-white border border-white/30 shadow-2xl">
                        <i id="confirm-icon" class="fa-solid fa-right-from-bracket text-2xl"></i>
                    </div>
                </div>

                <!-- Body Text -->
                <div class="p-8 pb-6 text-center">
                    <h3 id="confirm-title" class="text-2xl font-black text-slate-800 mb-2 tracking-tight">Konfirmasi
                    </h3>
                    <p id="confirm-message" class="text-slate-400 font-bold text-sm leading-relaxed px-2">Apakah Anda
                        yakin ingin melakukan tindakan ini?</p>
                </div>

                <!-- Footer Action Buttons -->
                <div class="px-8 pb-8 flex flex-col gap-3">
                    <button id="confirm-ok"
                        class="w-full py-4 rounded-[2rem] bg-indigo-600 text-white font-black text-xs uppercase tracking-[0.2em] shadow-xl shadow-indigo-100 hover:bg-indigo-700 hover:shadow-indigo-200 transition-all active:scale-95">
                        YA, LANJUTKAN
                    </button>
                    <button id="confirm-cancel"
                        class="w-full py-4 rounded-[2rem] bg-slate-50 text-slate-400 font-black text-xs uppercase tracking-[0.2em] hover:bg-slate-100 hover:text-slate-500 transition-all active:scale-95">
                        BATAL
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Prompt Modal -->
    <div id="password-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Login Admin</h3>
            <form id="password-form">
                <label for="password-input" class="block text-sm font-medium text-slate-600 mb-2">Masukkan Kata
                    Sandi</label>
                <input type="password" id="password-input"
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                <p id="password-error" class="text-red-500 text-sm mt-2 hidden">Kata sandi salah.</p>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="password-cancel"
                        class="bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">Batal</button>
                    <button type="submit" id="password-submit"
                        class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Masuk</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Presence Modal (Tracking) -->
    <div id="presence-modal" class="hidden fixed inset-0 z-[100] transition-all duration-300">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div
                class="bg-white w-full max-w-[400px] rounded-[3rem] shadow-2xl border border-white/40 overflow-hidden transform transition-all animate-pop-in">
                <div class="bg-indigo-600 p-8 text-white relative">
                    <button id="close-presence-modal"
                        class="absolute top-6 right-6 text-white/50 hover:text-white transition-colors">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                    <div class="flex items-center gap-4">
                        <div
                            class="w-12 h-12 bg-white/20 backdrop-blur-xl rounded-2xl flex items-center justify-center border border-white/30">
                            <i class="fa-solid fa-satellite-dish text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-black tracking-tight">Visitor Tracking</h3>
                            <p class="text-indigo-100 text-xs font-bold uppercase tracking-widest opacity-70">Realtime
                                Monitor</p>
                        </div>
                    </div>
                </div>

                <!-- Tabs (NEW) -->
                <div class="flex border-b border-slate-100 bg-slate-50/50">
                    <button id="tab-online"
                        class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest text-indigo-600 border-b-2 border-indigo-600 transition-all">
                        <i class="fa-solid fa-signal mr-1.5"></i> Online
                    </button>
                    <button id="tab-history"
                        class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-indigo-600 transition-all">
                        <i class="fa-solid fa-clock-rotate-left mr-1.5"></i> History
                    </button>
                </div>

                <div class="p-6">
                    <!-- Section: Online List -->
                    <div id="presence-list" class="space-y-3 max-h-[350px] overflow-y-auto pr-2 custom-scrollbar">
                        <!-- Presence items go here -->
                        <div class="animate-pulse flex space-x-4">
                            <div class="rounded-full bg-slate-200 h-10 w-10"></div>
                            <div class="flex-1 space-y-6 py-1">
                                <div class="h-2 bg-slate-200 rounded"></div>
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="h-2 bg-slate-200 rounded col-span-2"></div>
                                    <div class="h-2 bg-slate-200 rounded col-span-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section: History List (NEW) -->
                    <div id="history-list" class="hidden space-y-4 max-h-[350px] overflow-y-auto pr-2 custom-scrollbar">
                        <div class="text-center py-10">
                            <div class="spinner mx-auto mb-4 scale-75 opacity-50"></div>
                            <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Memuat Riwayat...
                            </p>
                        </div>
                    </div>
                </div>

                <div class="px-8 pb-8">
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100 flex items-center justify-between">
                        <span class="text-xs font-black text-slate-400 uppercase tracking-widest">Total Online</span>
                        <span id="total-online-count" class="text-lg font-black text-indigo-600">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script type="module">
        // --- SUPABASE CONFIG ---
        // SQL untuk membuat tabel (JALANKAN DI SUPABASE SQL EDITOR):
        /*
        -- 1. Buat tabel 'items'
        CREATE TABLE public.items (
          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          kode TEXT UNIQUE,
          nama TEXT,
          masalah TEXT,
          gambar TEXT,
          created_at TIMESTAMPTZ DEFAULT now()
        );

        -- 2. Aktifkan Row Level Security (RLS)
        -- NONAKTIFKAN INI JIKA ANDA INGIN AKSES MUDAH (TUTORIAL_MEMATIKAN_RLS.MD)
        -- ALTER TABLE public.items ENABLE ROW LEVEL SECURITY;

        -- 3. Buat policy agar semua (anon) bisa membaca data
        -- HAPUS JIKA RLS DIMATIKAN
        CREATE POLICY "Allow public read access"
          ON public.items
          FOR SELECT
          USING (true);

        -- 4. Buat policy agar semua (anon) bisa menambah, mengubah, dan menghapus data
        -- HAPUS JIKA RLS DIMATIKAN
        CREATE POLICY "Allow public full access"
          ON public.items
          FOR ALL
          USING (true)
          WITH CHECK (true);
        
        -- 5. SQL UNTUK MEMBUAT BUCKET STORAGE (dari tutorial_storage.md)
        -- CUKUP BUAT LEWAT UI: Buat bucket publik baru bernama 'gambar-barang'

        -- 6. Tabel History Aktivitas (BARU)
        /*
        CREATE TABLE public.activity_logs (
          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          user_nickname TEXT,
          role TEXT,
          action TEXT,
          details TEXT,
          created_at TIMESTAMPTZ DEFAULT now()
        );
        */

        const SUPABASE_URL = typeof __supabase_url !== 'undefined' ? __supabase_url : 'https://hxkpkadtxfxiiafsybls.supabase.co';
        const SUPABASE_ANON_KEY = typeof __supabase_anon_key !== 'undefined' ? __supabase_anon_key : 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4a3BrYWR0eGZ4aWlhZnN5YmxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwOTQ2OTQsImV4cCI6MjA3ODY3MDY5NH0.inY35kcqZWGz-HyNEntKevhKpJx0SgZcD7Fz2fwYC8o';
        const BUCKET_NAME = 'gambar-barang';

        // --- Global Variables ---
        let supabase;
        let items = []; // Cache lokal untuk data
        let isInitialLoading = true; // --- BARU: Flag untuk status loading awal ---
        let realtimeChannel; // Untuk menyimpan channel realtime Supabase
        let presenceChannel; // --- BARU: Channel untuk Presence ---
        let currentPresence = {}; // --- BARU: Cache status presence ---

        // --- Fungsi Deteksi Perangkat ---
        function getDeviceInfo() {
            const ua = navigator.userAgent;

            // 1. Android - Kadang menyertakan Merk/Model (misal: Samsung SM-G960F)
            if (/android/i.test(ua)) {
                const match = ua.match(/Android.*;\s+([^;]+)\s+Build/i) || ua.match(/\(([^;]+);\s+([^;)]+)\s+Build/i);
                const model = match ? (match[2] || match[1]) : "Android";
                return model.length > 20 ? "Android" : model;
            }

            // 2. iOS (iPhone/iPad) - Browser membatasi info model spesifik
            if (/iPhone/.test(ua)) return "iPhone";
            if (/iPad/.test(ua)) return "iPad";

            // 3. Windows - Tidak memberikan merk fisik (Asus/Dell dll) lewat browser
            if (/Windows/.test(ua)) {
                if (/Windows NT 10.0/.test(ua)) return "Windows 10/11";
                if (/Windows NT 6.1/.test(ua)) return "Windows 7";
                return "Windows PC";
            }

            // 4. Mac
            if (/Macintosh/.test(ua)) return "Mac device";

            return "Perangkat";
        }

        let userNickname = `${getDeviceInfo()}-${Math.floor(Math.random() * 9000) + 1000}`;
        let userRole = 'Operator'; // Default role
        let scrollTimer; // --- BARU: Timer untuk debounce scroll event ---

        // --- DOM Elements ---
        const roleSelectionView = document.getElementById('role-selection-view');
        const adminView = document.getElementById('admin-view');
        const operatorView = document.getElementById('operator-view');
        const connectionStatus = document.getElementById('connection-status');
        const adminRoleBtn = document.getElementById('admin-role-btn');
        const operatorRoleBtn = document.getElementById('operator-role-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const operatorLogoutBtn = document.getElementById('operator-logout-btn');
        const itemForm = document.getElementById('item-form');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const imagePreview = document.getElementById('image-preview');
        const imageInput = document.getElementById('gambar-barang');
        const itemListDiv = document.getElementById('item-list');
        const itemListContainer = document.getElementById('item-list-container'); // Container untuk event listener
        const operatorItemListDiv = document.getElementById('operator-item-list');
        const loadingSpinnerAdmin = document.getElementById('loading-spinner-admin');
        const loadingSpinnerOperator = document.getElementById('loading-spinner-operator');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const searchResultDiv = document.getElementById('search-result');
        const searchDots = document.getElementById('search-dots'); // --- BARU ---
        const operatorItemListContainer = document.getElementById('operator-item-list-container');
        const imageModal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-img');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmCancelBtn = document.getElementById('confirm-cancel');
        const confirmOkBtn = document.getElementById('confirm-ok');
        const menuBtnGlobal = document.getElementById('menu-btn-global');
        const menuSidebar = document.getElementById('menu-sidebar');
        const menuOverlay = document.getElementById('menu-overlay');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const menuHomeBtn = document.getElementById('menu-home-btn');
        const menuAdminBtn = document.getElementById('menu-admin-btn');
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const passwordInput = document.getElementById('password-input');
        const passwordError = document.getElementById('password-error');
        const passwordCancelBtn = document.getElementById('password-cancel');
        const presenceModal = document.getElementById('presence-modal');
        const presenceList = document.getElementById('presence-list');
        const totalOnlineCount = document.getElementById('total-online-count');
        const closePresenceBtn = document.getElementById('close-presence-modal');
        const trackingBtnOperator = document.getElementById('tracking-btn-operator');
        const trackingBtnAdmin = document.getElementById('tracking-btn-admin');
        const onlineCountBadge = document.getElementById('online-count-badge');
        const tabOnline = document.getElementById('tab-online');
        const tabHistory = document.getElementById('tab-history');
        const historyList = document.getElementById('history-list');
        const toggleFormBtn = document.getElementById('toggle-form-btn');
        const adminFormContainer = document.getElementById('admin-form-container');
        const totalItemsCount = document.getElementById('total-items-count');
        const toggleFormIcon = document.getElementById('toggle-form-icon');
        const toggleFormText = document.getElementById('toggle-form-text');
        const searchInputAdmin = document.getElementById('search-input-admin');
        const searchClearAdmin = document.getElementById('search-clear-admin');
        const adminItemsContent = document.getElementById('admin-items-content');
        const toggleAdminItemsBtn = document.getElementById('toggle-admin-items-btn');
        const toggleAdminItemsIcon = document.getElementById('toggle-admin-items-icon');
        const toggleAdminItemsText = document.getElementById('toggle-admin-items-text');

        let currentZoom = 1;

        // --- UTILITY FUNCTIONS ---
        function showView(view) {
            roleSelectionView.classList.add('hidden');
            adminView.classList.add('hidden');
            operatorView.classList.add('hidden');

            // Pusatkan tampilan pemilihan peran
            if (view === 'role') {
                roleSelectionView.classList.remove('hidden');
                document.getElementById('app').classList.add('justify-center');
            } else {
                document.getElementById('app').classList.remove('justify-center');
                if (view === 'admin') adminView.classList.remove('hidden');
                else if (view === 'operator') operatorView.classList.remove('hidden');
            }
        }

        function showConfirmation(config) {
            confirmTitle.textContent = config.title;
            confirmMessage.textContent = config.message;
            confirmOkBtn.textContent = config.okText || 'OK';
            confirmCancelBtn.textContent = config.cancelText || 'Batal';

            // Set Theme (Indigo for General, Rose for Delete)
            const iconEl = document.getElementById('confirm-icon');
            const headerEl = document.getElementById('confirm-header');
            const isDelete = config.okText && config.okText.toLowerCase().includes('hapus');

            if (isDelete) {
                iconEl.className = 'fa-solid fa-trash-can text-2xl';
                headerEl.className = 'h-32 bg-rose-600 relative flex items-center justify-center';
                confirmOkBtn.className = 'w-full py-4 rounded-[2rem] bg-rose-600 text-white font-black text-xs uppercase tracking-[0.2em] shadow-xl shadow-rose-100 hover:bg-rose-700 hover:shadow-rose-200 transition-all active:scale-95';
            } else {
                iconEl.className = 'fa-solid fa-right-from-bracket text-2xl';
                headerEl.className = 'h-32 bg-indigo-600 relative flex items-center justify-center';
                confirmOkBtn.className = 'w-full py-4 rounded-[2rem] bg-indigo-600 text-white font-black text-xs uppercase tracking-[0.2em] shadow-xl shadow-indigo-100 hover:bg-indigo-700 hover:shadow-indigo-200 transition-all active:scale-95';
            }

            confirmCancelBtn.classList.toggle('hidden', config.onCancel === undefined && config.cancelText === undefined);

            confirmModal.classList.remove('hidden');

            const okHandler = () => {
                if (config.onOk) config.onOk();
                hideConfirmation();
            };

            const cancelHandler = () => {
                if (config.onCancel) config.onCancel();
                hideConfirmation();
            }

            confirmOkBtn.onclick = okHandler;
            confirmCancelBtn.onclick = cancelHandler;
        }

        function hideConfirmation() {
            confirmModal.classList.add('hidden');
            confirmOkBtn.onclick = null;
            confirmCancelBtn.onclick = null;
        }

        function openMenu() {
            menuOverlay.classList.remove('hidden');
            // Animate opacity
            setTimeout(() => menuOverlay.classList.add('opacity-100'), 10);
            menuSidebar.classList.add('open');
        }

        function closeMenu() {
            menuOverlay.classList.remove('opacity-100');
            menuSidebar.classList.remove('open');
            // Hide after transition
            setTimeout(() => menuOverlay.classList.add('hidden'), 300);
        }

        function showPasswordModal() {
            passwordInput.value = '';
            passwordError.classList.add('hidden');
            passwordModal.classList.remove('hidden');
            passwordInput.focus();
        }

        function hidePasswordModal() {
            passwordModal.classList.add('hidden');
        }

        // --- SUPABASE DATA HANDLING ---

        async function fetchAllItems() {
            if (!supabase) return;

            console.log("Fetching all items...");
            const { data, error } = await supabase
                .from('items')
                .select('*');
            // .order('created_at', { ascending: false }); // Hindari order by jika tidak ada indeks

            if (error) {
                console.error('Error fetching items:', error);
                const errorMsg = `<p class="text-red-500">Gagal mengambil data: ${error.message}</p>`;
                // PERBAIKAN: Sesuaikan warna teks error spinner
                if (loadingSpinnerAdmin && loadingSpinnerAdmin.querySelector('p')) {
                    loadingSpinnerAdmin.querySelector('p').classList.remove('text-slate-800'); // Hapus warna lama jika ada
                    loadingSpinnerAdmin.querySelector('p').classList.add('text-red-500'); // Tambah warna error
                    loadingSpinnerAdmin.querySelector('p').textContent = `Gagal mengambil data: ${error.message}`;
                    if (loadingSpinnerAdmin.querySelector('.spinner')) loadingSpinnerAdmin.querySelector('.spinner').classList.add('hidden');
                }

                if (loadingSpinnerOperator) loadingSpinnerOperator.innerHTML = errorMsg;
            } else {
                items = data || [];
                isInitialLoading = false; // --- BARU: Selesai loading awal ---
                console.log(`Berhasil mengambil ${items.length} data.`);
                renderAdminList();
                renderOperatorList();
                if (loadingSpinnerAdmin) loadingSpinnerAdmin.classList.add('hidden');
                if (loadingSpinnerOperator) loadingSpinnerOperator.classList.add('hidden');
            }
        }

        // --- PRESENCE LOGIC (NEW) ---
        function setupPresence() {
            if (!supabase) return;

            console.log("Setting up Presence...");
            presenceChannel = supabase.channel('online-users');

            presenceChannel
                .on('presence', { event: 'sync' }, () => {
                    const newState = presenceChannel.presenceState();
                    console.log('Presence Sync:', newState);
                    currentPresence = newState;
                    updatePresenceUI();
                })
                .on('presence', { event: 'join', key: 'user' }, ({ key, newPresences }) => {
                    console.log('User joined:', newPresences);
                })
                .on('presence', { event: 'leave', key: 'user' }, ({ key, leftPresences }) => {
                    console.log('User left:', leftPresences);
                })
                .subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        const presenceTrackStatus = await presenceChannel.track({
                            user: userNickname,
                            role: userRole,
                            online_at: new Date().toISOString(),
                        });
                        console.log('Presence Track Status:', presenceTrackStatus);

                        // Log Entry
                        logActivity('Membuka Website');
                    }
                });
        }

        function updatePresenceUI() {
            if (!presenceList) return;

            // Extract users from presence state
            const users = [];
            Object.values(currentPresence).forEach(presenceArray => {
                presenceArray.forEach(p => users.push(p));
            });

            // Update Total Count
            if (totalOnlineCount) totalOnlineCount.textContent = users.length;
            if (onlineCountBadge) onlineCountBadge.classList.toggle('hidden', users.length <= 1);

            // Render List
            presenceList.innerHTML = '';

            // Sort: Admin first, then by name
            users.sort((a, b) => {
                if (a.role === 'Admin' && b.role !== 'Admin') return -1;
                if (a.role !== 'Admin' && b.role === 'Admin') return 1;
                return a.user.localeCompare(b.user);
            });

            users.forEach(u => {
                const isAdmin = u.role === 'Admin';
                const isMe = u.user === userNickname;

                const itemHTML = `
                    <div class="flex items-center justify-between p-3.5 bg-white rounded-3xl border border-slate-100 transition-all hover:shadow-xl hover:shadow-indigo-50/50 group/item ${isMe ? 'ring-2 ring-indigo-500/10 bg-indigo-50/5' : ''}">
                        <div class="flex items-center gap-4">
                            <!-- Avatar with Status Dot -->
                            <div class="relative">
                                <div class="w-12 h-12 ${isAdmin ? 'bg-indigo-600 shadow-lg shadow-indigo-100' : 'bg-slate-100'} rounded-2xl flex items-center justify-center transition-transform group-hover/item:scale-110">
                                    <i class="fa-solid ${isAdmin ? 'fa-user-shield text-white' : 'fa-user-astronaut text-slate-400'} text-lg"></i>
                                </div>
                                <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-white rounded-full flex items-center justify-center shadow-sm">
                                    <div class="w-2.5 h-2.5 bg-green-500 rounded-full animate-pulse"></div>
                                </div>
                            </div>

                            <div>
                                <div class="flex items-center gap-2 mb-0.5">
                                    <h4 class="text-[14px] font-black text-slate-800 leading-tight">
                                        ${u.user}
                                    </h4>
                                    ${isMe ? '<span class="px-2 py-0.5 bg-indigo-100 text-indigo-600 text-[8px] font-black uppercase rounded-md tracking-tighter">Anda</span>' : ''}
                                </div>
                                <div class="flex items-center gap-1.5">
                                    <span class="text-[9px] font-black uppercase tracking-[0.15em] ${isAdmin ? 'text-indigo-600' : 'text-slate-400'}">
                                        ${u.role}
                                    </span>
                                    <span class="w-1 h-1 bg-slate-200 rounded-full"></span>
                                    <span class="text-[9px] font-bold text-slate-300 uppercase">Aktif Sekarang</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="hidden sm:block">
                            <div class="px-3 py-1 bg-slate-50 rounded-full border border-slate-100">
                                <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Online</span>
                            </div>
                        </div>
                    </div>
                `;
                presenceList.innerHTML += itemHTML;
            });
        }

        async function logActivity(action, details = '') {
            if (!supabase) return;
            try {
                await supabase.from('activity_logs').insert([{
                    user_nickname: userNickname,
                    role: userRole,
                    action: action,
                    details: details
                }]);
            } catch (e) {
                console.warn("Gagal mencatat log:", e);
            }
        }

        async function fetchHistory() {
            if (!supabase || !historyList) return;

            historyList.innerHTML = `
                <div class="text-center py-10">
                    <div class="spinner mx-auto mb-4 scale-75 opacity-50"></div>
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Memuat Riwayat...</p>
                </div>`;

            const { data, error } = await supabase
                .from('activity_logs')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(50);

            if (error) {
                historyList.innerHTML = `<p class="text-center text-red-500 text-xs font-bold py-10">Gagal memuat history</p>`;
                return;
            }

            if (!data || data.length === 0) {
                historyList.innerHTML = `<p class="text-center text-slate-400 text-xs font-bold py-10">Belum ada riwayat aktivitas</p>`;
                return;
            }

            historyList.innerHTML = '';
            data.forEach(log => {
                const date = new Date(log.created_at);
                const timeStr = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const dateStr = date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });

                let actionIcon = 'fa-circle-info';
                let iconColor = 'bg-slate-100 text-slate-400';

                if (log.action.includes('Tambah')) { actionIcon = 'fa-plus'; iconColor = 'bg-green-50 text-green-600'; }
                else if (log.action.includes('Update')) { actionIcon = 'fa-pen-to-square'; iconColor = 'bg-indigo-50 text-indigo-600'; }
                else if (log.action.includes('Hapus')) { actionIcon = 'fa-trash-can'; iconColor = 'bg-rose-50 text-rose-600'; }
                else if (log.action.includes('Membuka')) { actionIcon = 'fa-eye'; iconColor = 'bg-amber-50 text-amber-600'; }

                const logHTML = `
                    <div class="flex gap-4 group/log">
                        <div class="flex flex-col items-center">
                            <div class="w-8 h-8 ${iconColor} rounded-xl flex items-center justify-center text-xs shadow-sm group-hover/log:scale-110 transition-transform">
                                <i class="fa-solid ${actionIcon}"></i>
                            </div>
                            <div class="w-px h-full bg-slate-100 mt-2"></div>
                        </div>
                        <div class="flex-1 pb-6">
                            <div class="flex justify-between items-start mb-1">
                                <h4 class="text-xs font-black text-slate-800 tracking-tight leading-none">${log.user_nickname}</h4>
                                <span class="text-[9px] font-black text-slate-300 uppercase whitespace-nowrap">${dateStr}, ${timeStr}</span>
                            </div>
                            <p class="text-[11px] font-bold text-slate-500 mb-1 leading-snug">${log.action}</p>
                            ${log.details ? `
                                <div class="inline-flex items-center gap-1.5 px-2 py-0.5 bg-slate-50 border border-slate-100 rounded-md">
                                    <span class="text-[8px] font-black text-slate-400 uppercase tracking-tighter">${log.details}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                historyList.innerHTML += logHTML;
            });
        }

        function togglePresenceModal(show) {
            if (show) {
                presenceModal.classList.remove('hidden');
                document.body.classList.add('modal-open');
                // Auto switch to Online tab
                switchTab('online');
            } else {
                presenceModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }
        }

        function switchTab(tab) {
            if (tab === 'online') {
                tabOnline.classList.add('text-indigo-600', 'border-indigo-600', 'border-b-2');
                tabOnline.classList.remove('text-slate-400');
                tabHistory.classList.remove('text-indigo-600', 'border-indigo-600', 'border-b-2');
                tabHistory.classList.add('text-slate-400');
                presenceList.classList.remove('hidden');
                historyList.classList.add('hidden');
                document.querySelector('.px-8.pb-8').classList.remove('hidden'); // Show Total Online
            } else {
                tabHistory.classList.add('text-indigo-600', 'border-indigo-600', 'border-b-2');
                tabHistory.classList.remove('text-slate-400');
                tabOnline.classList.remove('text-indigo-600', 'border-indigo-600', 'border-b-2');
                tabOnline.classList.add('text-slate-400');
                historyList.classList.remove('hidden');
                presenceList.classList.add('hidden');
                document.querySelector('.px-8.pb-8').classList.add('hidden'); // Hide Total Online
                fetchHistory();
            }
        }

        async function updateRole(role) {
            userRole = role;
            if (presenceChannel) {
                await presenceChannel.track({
                    user: userNickname,
                    role: userRole,
                    online_at: new Date().toISOString(),
                });
            }
        }

        function setupRealtimeListener() {
            if (!supabase) return;

            console.log("Setting up Supabase realtime listener...");

            // Hentikan listener sebelumnya jika ada
            if (realtimeChannel) {
                supabase.removeChannel(realtimeChannel);
            }

            realtimeChannel = supabase
                .channel('public:items')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'items' },
                    (payload) => {
                        console.log('Perubahan realtime terdeteksi:', payload);

                        const idInForm = document.getElementById('item-id').value;
                        const idInFormNum = idInForm ? parseInt(idInForm, 10) : null;

                        switch (payload.eventType) {
                            case 'INSERT':
                                // PERBAIKAN: Cek dulu apakah item sudah ada di cache
                                const exists = items.some(item => item.id.toString() === payload.new.id.toString());
                                if (!exists) {
                                    items.push(payload.new);
                                }
                                break;
                            case 'UPDATE':
                                const updatedId = payload.new.id.toString();
                                items = items.map(item => item.id.toString() === updatedId ? payload.new : item);
                                // Jika data yg sedang diedit diubah orang lain, reset form
                                if (payload.new.id === idInFormNum) {
                                    resetForm();
                                }
                                break;
                            case 'DELETE':
                                const deletedId = payload.old.id.toString(); // Ubah ID yang dihapus ke string
                                items = items.filter(item => item.id.toString() !== deletedId); // Bandingkan sebagai string

                                // Jika data yg sedang diedit dihapus, reset form
                                if (payload.old.id === idInFormNum) {
                                    resetForm();
                                }
                                break;
                        }

                        // Sortir ulang data (opsional, jika perlu)
                        // items.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                        renderAdminList();
                        renderOperatorList();
                    }
                )
                .subscribe();

            // Ambil data awal saat listener siap
            fetchAllItems();
        }

        // Fungsi baru untuk upload gambar ke Supabase Storage
        async function uploadImage(file) {
            if (!supabase) {
                throw new Error("Supabase client not initialized.");
            }

            // Buat nama file unik
            const fileName = `public/${Date.now()}-${file.name}`;

            // Upload ke bucket
            const { data: uploadData, error: uploadError } = await supabase
                .storage
                .from(BUCKET_NAME)
                .upload(fileName, file);

            if (uploadError) {
                console.error("Error uploading image:", uploadError);
                throw uploadError;
            }

            // Dapatkan URL publik
            const { data: publicUrlData } = supabase
                .storage
                .from(BUCKET_NAME)
                .getPublicUrl(uploadData.path);

            if (!publicUrlData || !publicUrlData.publicUrl) {
                throw new Error("Could not get public URL for uploaded image.");
            }

            console.log("Image uploaded, URL:", publicUrlData.publicUrl);
            return { url: publicUrlData.publicUrl, path: uploadData.path };
        }

        async function addItem(itemData) {
            if (!supabase) return null;
            try {
                // PERBAIKAN: Tambahkan .select() untuk mengembalikan data baru
                const { data, error } = await supabase.from('items').insert([itemData]).select();
                if (error) throw error;
                return data[0]; // Kembalikan item baru
            } catch (e) {
                console.error("Error adding document: ", e);
                showConfirmation({ title: 'Error', message: `Gagal menyimpan data: ${e.message}`, okText: 'OK' });
                return null;
            }
        }

        async function updateItem(id, itemData) {
            if (!supabase) return null;
            try {
                // PERBAIKAN: Tambahkan .select() untuk mengembalikan data yang diupdate
                const { data, error } = await supabase.from('items').update(itemData).eq('id', id).select();
                if (error) throw error;
                return data[0]; // Kembalikan item yang diupdate
            } catch (e) {
                console.error("Error updating document: ", e);
                showConfirmation({ title: 'Error', message: `Gagal mengupdate data: ${e.message}`, okText: 'OK' });
                return null;
            }
        }

        async function deleteItem(item) {
            if (!supabase) return;
            try {
                // 1. Hapus data dari tabel 'items'
                const { error: dbError } = await supabase.from('items').delete().eq('id', item.id);
                if (dbError) throw dbError;

                logActivity('Hapus Data Barang', item.kode);

                // 2. Hapus gambar dari Storage (jika ada)
                if (item.gambar) {
                    // Ekstrak path file dari URL
                    // URL: .../storage/v1/object/public/gambar-barang/public/1729739502220-myimage.png
                    // Path: public/1729739502220-myimage.png
                    const urlParts = item.gambar.split(`/${BUCKET_NAME}/`);
                    if (urlParts.length > 1) {
                        const filePath = urlParts[1];
                        console.log("Menghapus file dari storage:", filePath);
                        const { error: storageError } = await supabase
                            .storage
                            .from(BUCKET_NAME)
                            .remove([filePath]);

                        if (storageError) {
                            // Jangan blokir jika gagal hapus file, tapi catat errornya
                            console.warn("Gagal menghapus file di storage:", storageError.message);
                        }
                    }
                }
            } catch (e) {
                console.error("Error deleting document: ", e);
                showConfirmation({ title: 'Error', message: `Gagal menghapus data: ${e.message}`, okText: 'OK' });
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderAdminList(filteredItems = null) {
            if (!itemListDiv) return;

            const itemsToRender = filteredItems || items;

            // --- Update Total Count Stats ---
            if (totalItemsCount && !filteredItems) {
                totalItemsCount.textContent = items.length;
            }

            itemListDiv.innerHTML = ''; // Kosongkan daftar sebelum render ulang

            // Tampilkan spinner jika perlu (jika items kosong dan loading belum selesai)
            const isLoading = itemsToRender.length === 0 && loadingSpinnerAdmin && !loadingSpinnerAdmin.classList.contains('hidden') && !filteredItems;
            if (loadingSpinnerAdmin) loadingSpinnerAdmin.classList.toggle('hidden', !isLoading);

            if (itemsToRender.length === 0) {
                const msg = filteredItems ? "Tidak ada barang yang cocok dengan pencarian." : "Belum ada data barang.";
                itemListDiv.innerHTML = `<p class="text-slate-500 font-bold text-lg col-span-full text-center py-10 opacity-60">${msg}</p>`;
                return;
            }

            itemsToRender.forEach(item => {
                const itemCardHTML = `
                <div class="card-item group bg-white rounded-[2.5rem] shadow-sm border border-slate-200/80 overflow-hidden transition-all duration-500 hover:shadow-2xl hover:shadow-indigo-100 hover:-translate-y-2 flex flex-col h-auto sm:min-h-[480px]">
                    <!-- Foto Barang -->
                    <div class="relative h-56 sm:h-60 overflow-hidden flex-shrink-0 p-3">
                        <img src="${item.gambar || 'https://placehold.co/400x300/e2e8f0/64748b?text=No+Image'}" alt="${item.nama}" 
                             class="w-full h-full object-cover rounded-3xl transition-transform duration-700 group-hover:scale-105 cursor-pointer shadow-sm border border-slate-100"
                             onclick="window.app.showImageModal('${item.gambar || ''}')"
                             onerror="this.src='https://placehold.co/400x300/e2e8f0/64748b?text=No+Image';">
                        
                        <!-- Overlay Glassmorphism saat Hover -->
                        <div class="absolute inset-x-3 inset-y-3 bg-indigo-600/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none rounded-3xl"></div>
                    </div>

                    <div class="p-6 flex flex-col flex-grow overflow-hidden">
                        <!-- Judul: Nama + Kode -->
                        <div class="mb-4 flex-shrink-0">
                            <h3 class="text-xl font-black text-slate-800 leading-tight group-hover:text-indigo-600 transition-colors uppercase truncate">
                                ${item.nama || 'Tanpa Nama'} <span class="text-indigo-600 opacity-70 ml-2 font-bold">${item.kode || ''}</span>
                            </h3>
                        </div>

                        <!-- Box Masalah -->
                        <div class="bg-slate-50 border border-slate-200/60 rounded-3xl p-5 transition-all hover:bg-white hover:shadow-lg hover:shadow-indigo-50/50 group/alert overflow-hidden flex-grow flex items-start">
                            <div class="flex items-start gap-4 w-full">
                                <div class="flex-shrink-0 w-10 h-10 bg-white rounded-xl shadow-sm border border-slate-100 flex items-center justify-center text-amber-500">
                                    <i class="fa-solid fa-triangle-exclamation text-sm"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <span class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1.5 opacity-70">Diagnosa</span>
                                    <p class="text-[14px] font-bold text-slate-600 leading-snug break-words line-clamp-4">${item.masalah || '-'}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Baris Aksi Admin -->
                        <div class="flex items-center justify-between mt-auto pt-4 border-t border-slate-100/60 flex-shrink-0">
                            <div class="flex gap-2">
                                <button class="edit-btn p-2.5 rounded-xl bg-indigo-50 text-indigo-600 hover:bg-indigo-600 hover:text-white transition-all shadow-sm" data-id="${item.id}" title="Edit Data">
                                    <i class="fa-solid fa-pen-to-square text-sm pointer-events-none"></i>
                                </button>
                                <button class="delete-btn p-2.5 rounded-xl bg-rose-50 text-rose-600 hover:bg-rose-600 hover:text-white transition-all shadow-sm" data-id="${item.id}" title="Hapus Data">
                                    <i class="fa-solid fa-trash-can text-sm pointer-events-none"></i>
                                </button>
                            </div>
                            <span class="text-[9px] font-black text-slate-300 uppercase tracking-widest bg-slate-50 px-2 py-1 rounded-md border border-slate-100">ID: #${item.id}</span>
                        </div>
                    </div>
                </div>
                `;
                const cardElement = new DOMParser().parseFromString(itemCardHTML, 'text/html').body.firstChild;
                itemListDiv.appendChild(cardElement);
            });
        }

        function renderOperatorList() {
            if (!operatorItemListDiv) return;
            operatorItemListDiv.innerHTML = '';

            if (items.length === 0 && !isInitialLoading) {
                operatorItemListDiv.innerHTML = `<p class="text-slate-700 font-semibold text-lg col-span-full text-center py-10">Belum ada data barang.</p>`; // Sesuaikan teks
                return;
            } else if (isInitialLoading) {
                // Tampilkan pesan loading jika sedang fetch
                operatorItemListDiv.innerHTML = `
                    <div class="col-span-full text-center py-16 flex flex-col items-center animate-fade-in">
                        <div class="spinner mb-5 shadow-inner"></div>
                        <p class="text-slate-500 font-medium italic">Mengambil data terbaru...</p>
                    </div>`;
                return;
            }

            items.forEach(item => {
                const itemCard = `
                <div class="card-item group bg-white rounded-[2.5rem] shadow-sm border border-slate-200/80 overflow-hidden transition-all duration-500 hover:shadow-2xl hover:shadow-indigo-100 hover:-translate-y-2 flex flex-col h-auto sm:min-h-[460px]">
                    <!-- Foto Area -->
                    <div class="relative h-52 sm:h-56 overflow-hidden flex-shrink-0 p-3">
                        <img src="${item.gambar || 'https://placehold.co/400x300/e2e8f0/64748b?text=No+Image'}" alt="${item.nama}" 
                             class="w-full h-full object-cover rounded-[1.8rem] transition-transform duration-700 group-hover:scale-110 cursor-pointer shadow-md border border-slate-100"
                             onclick="window.app.showImageModal('${item.gambar || ''}')"
                             onerror="this.src='https://placehold.co/400x300/e2e8f0/64748b?text=No+Image';">
                    </div>

                    <!-- Content Area -->
                    <div class="px-6 pb-6 flex flex-col flex-grow overflow-hidden">
                        <div class="mb-4 flex-shrink-0">
                            <h3 class="text-xl sm:text-2xl font-black text-slate-900 leading-none group-hover:text-indigo-600 transition-colors uppercase truncate tracking-tighter">
                                ${item.nama || 'Tanpa Nama'} <span class="text-indigo-600/60 ml-1 font-bold italic">${item.kode || ''}</span>
                            </h3>
                        </div>

                        <!-- Diagnosis Box -->
                        <div class="bg-indigo-50/30 border border-indigo-100/50 rounded-[2rem] p-5 transition-all hover:bg-white hover:shadow-lg hover:shadow-indigo-100/50 group/alert overflow-hidden flex-grow flex items-start">
                            <div class="flex items-start gap-4 w-full">
                                <div class="flex-shrink-0 w-10 h-10 bg-white rounded-2xl shadow-sm border border-slate-100 flex items-center justify-center text-amber-500">
                                    <i class="fa-solid fa-triangle-exclamation text-sm"></i>
                                </div>
                                <div class="min-w-0 flex-1">
                                    <span class="block text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1.5 opacity-70">Laporan Diagnosa</span>
                                    <p class="text-[14px] sm:text-[15px] font-black text-slate-700 leading-snug break-words line-clamp-4">${item.masalah || '-'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                const cardElement = new DOMParser().parseFromString(itemCard, 'text/html').body.firstChild;
                operatorItemListDiv.appendChild(cardElement);
            });
        }

        // --- PERUBAHAN FUNGSI INI (ditambah logika dot) ---
        function displaySearchResult(foundItems) { // Terima array, bukan 1 item
            if (foundItems && foundItems.length > 0) { // Cek jika array tidak kosong
                let html = ''; // Siapkan string HTML untuk menampung semua hasil

                // Loop setiap item yang ditemukan
                foundItems.forEach(item => {
                    html += `
                    <div class="card-search-result bg-white rounded-[2.5rem] shadow-2xl shadow-indigo-100/10 overflow-hidden border border-slate-200/80 w-[88vw] md:w-full flex-shrink-0 mb-8 transition-all hover:shadow-indigo-200/20 h-auto md:h-72 flex flex-col md:flex-row p-2.5">
                        <!-- Sisi Kiri: Foto Produk -->
                        <div class="w-full md:w-72 relative h-64 md:h-full flex-shrink-0">
                            <img src="${item.gambar || 'https://placehold.co/400x400/e2e8f0/64748b?text=Foto'}" 
                                 alt="${item.nama}" 
                                 class="w-full h-full object-cover rounded-[2rem] cursor-pointer hover:scale-105 transition-transform duration-500 shadow-sm border border-slate-100" 
                                 onclick="window.app.showImageModal('${item.gambar || ''}')" 
                                 onerror="this.src='https://placehold.co/400x440/e2e8f0/64748b?text=Foto';">
                        </div>

                        <!-- Sisi Kanan: Detail Informasi -->
                        <div class="p-6 md:p-10 flex-1 flex flex-col justify-center bg-gradient-to-br from-white to-slate-50/20 overflow-hidden">
                            <div class="mb-4 flex-shrink-0">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="w-2 h-2 bg-indigo-600 rounded-full animate-pulse"></span>
                                    <span class="text-indigo-600 font-black text-[9px] uppercase tracking-[0.4em]">Hasil Pencarian Kode</span>
                                </div>
                                <h3 class="text-xl md:text-4xl font-black text-slate-800 leading-tight uppercase tracking-tight truncate">
                                    ${item.nama || 'Nama Barang'} <span class="text-indigo-600/60 ml-2">${item.kode || ''}</span>
                                </h3>
                            </div>

                            <div class="bg-white rounded-[2rem] p-5 md:p-6 border border-slate-200/60 shadow-sm relative group/info overflow-hidden flex-shrink-0">
                                <div class="relative flex items-center gap-5">
                                    <div class="flex-shrink-0 w-12 h-12 bg-indigo-50 rounded-2xl flex items-center justify-center text-amber-500 shadow-inner">
                                        <i class="fa-solid fa-triangle-exclamation text-base"></i>
                                    </div>
                                    <div class="min-w-0">
                                        <span class="block text-[8px] font-black text-slate-300 uppercase tracking-widest mb-1.5">Laporan Diagnosa:</span>
                                        <p class="text-base md:text-xl font-black text-slate-600 leading-relaxed truncate">${item.masalah || '-'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                });

                searchResultDiv.innerHTML = html; // Set HTML gabungan

                // --- LOGIKA DOT BARU ---
                searchDots.innerHTML = ''; // Kosongkan dots sebelumnya

                if (foundItems.length > 1) { // Hanya tampilkan dots jika item lebih dari 1
                    searchDots.classList.remove('hidden');
                    searchDots.classList.add('flex'); // Pastikan 'flex' untuk justify-center

                    const cards = searchResultDiv.children;

                    foundItems.forEach((item, index) => {
                        const dot = document.createElement('span');
                        dot.className = 'dot';
                        dot.dataset.index = index;
                        dot.addEventListener('click', () => {
                            // Scroll ke card yang sesuai
                            cards[index].scrollIntoView({
                                behavior: 'smooth',
                                block: 'nearest',
                                inline: 'start'
                            });
                        });
                        searchDots.appendChild(dot);
                    });

                    updateActiveDot(); // Panggil sekali untuk set dot aktif pertama

                } else {
                    searchDots.classList.add('hidden');
                    searchDots.classList.remove('flex');
                }
                // --- AKHIR LOGIKA DOT ---

            } else {
                // Tampilkan pesan jika tidak ada hasil
                searchResultDiv.innerHTML = `<p class="text-center text-red-600 font-semibold bg-white p-8 rounded-2xl shadow-lg border border-red-200">Tidak ada barang yang ditemukan dengan awalan kode tersebut.</p>`;
                searchDots.innerHTML = ''; // Kosongkan dots
                searchDots.classList.add('hidden');
            }

            searchResultDiv.classList.remove('hidden');
            operatorItemListContainer.classList.add('hidden');
        }

        // Definisikan 'app' pada window agar bisa diakses oleh onclick di HTML
        window.app = {
            showImageModal: (src) => {
                if (!src) return;
                modalImg.src = src;
                currentZoom = 1;
                modalImg.style.transform = 'scale(1)';
                imageModal.classList.remove('hidden');
                document.body.classList.add('modal-open');
            }
        };

        function hideImageModal() {
            imageModal.classList.add('hidden');
            document.body.classList.remove('modal-open');
        }

        // --- EVENT HANDLERS ---

        // Listener global untuk tombol edit/hapus
        function handleGlobalClick(e) {
            // Cek tombol edit
            const editBtn = e.target.closest('.edit-btn');
            if (editBtn) {
                handleEditClick(editBtn);
                return;
            }

            // Cek tombol hapus
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                handleDeleteClick(deleteBtn);
                return;
            }
        }

        // --- FUNGSI BARU UNTUK DOTS ---
        // Fungsi ini dijalankan saat user scroll/swipe
        function handleScrollUpdateDots() {
            // Debounce: Tunda eksekusi agar tidak berat
            clearTimeout(scrollTimer);
            scrollTimer = setTimeout(updateActiveDot, 100); // Tunggu 100ms setelah scroll berhenti
        }

        // --- FUNGSI BARU UNTUK DOTS ---
        // Logika untuk menentukan dot mana yang aktif
        function updateActiveDot() {
            if (!searchResultDiv || !searchDots) return;

            const cards = searchResultDiv.children;
            const dots = searchDots.children;
            if (dots.length === 0) return;

            // Dapatkan posisi tengah container
            const containerCenter = searchResultDiv.scrollLeft + searchResultDiv.offsetWidth / 2;

            let closestIndex = 0;
            let smallestDistance = Infinity;

            // Cari card yang paling dekat dengan tengah
            for (let i = 0; i < cards.length; i++) {
                const card = cards[i];
                const cardCenter = card.offsetLeft + card.offsetWidth / 2;
                const distance = Math.abs(containerCenter - cardCenter);

                if (distance < smallestDistance) {
                    smallestDistance = distance;
                    closestIndex = i;
                }
            }

            // Update class 'active' pada dots
            for (let i = 0; i < dots.length; i++) {
                dots[i].classList.toggle('active', i === closestIndex);
            }
        }

        // --- PERUBAHAN FUNGSI INI ---
        function handleSearch() {
            const query = searchInput.value.trim().toUpperCase();
            if (!query) {
                // Jika query kosong, bersihkan pencarian (tampilkan semua item)
                clearSearch();
                return;
            }
            // GANTI DARI .find() (mencari 1) ke .filter() (mencari banyak)
            // GANTI DARI === (sama persis) ke .startsWith() (dimulai dengan)
            const foundItems = items.filter(item => item.kode.toUpperCase().startsWith(query));

            // Kirim array hasil filter ke fungsi display (fungsi display juga sudah diubah)
            displaySearchResult(foundItems);
        }

        function clearSearch() {
            searchInput.value = '';
            searchResultDiv.innerHTML = '';
            searchResultDiv.classList.add('hidden');
            searchDots.innerHTML = ''; // --- BARU: Bersihkan dots ---
            searchDots.classList.add('hidden'); // --- BARU: Sembunyikan dots ---
            operatorItemListContainer.classList.remove('hidden');
        }

        // --- BUG FIX: FUNGSI INI DIUBAH ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('item-id').value;
            const file = imageInput.files[0];

            let itemData = {
                kode: document.getElementById('kode-barang').value.toUpperCase(),
                nama: document.getElementById('nama-barang').value.toUpperCase(),
                masalah: document.getElementById('permasalahan').value.toUpperCase(),
                // gambar akan ditambahkan nanti
            };

            submitBtn.disabled = true;
            submitBtn.textContent = 'Menyimpan...';

            try {
                let imageUrl = undefined;
                // Path tidak perlu disimpan lagi di sini
                // let imagePath = undefined; 

                if (file) {
                    // 1. Upload gambar baru
                    console.log("Mengupload gambar baru...");
                    const { url, path } = await uploadImage(file); // 'path' tidak digunakan, tapi biarkan
                    imageUrl = url;
                }

                if (id) {
                    // UPDATE
                    const existingItem = items.find(item => item.id.toString() === id);
                    if (!existingItem) {
                        throw new Error("Item tidak ditemukan untuk di-update.");
                    }

                    // Jika ada gambar baru, hapus gambar lama dari storage
                    if (file && existingItem.gambar) {
                        console.log("Menghapus gambar lama...");
                        const urlParts = existingItem.gambar.split(`/${BUCKET_NAME}/`);
                        if (urlParts.length > 1) {
                            const oldPath = urlParts[1];
                            await supabase.storage.from(BUCKET_NAME).remove([oldPath]);
                        }
                    }

                    // Siapkan data update
                    const updatedData = { ...itemData };
                    if (imageUrl !== undefined) {
                        updatedData.gambar = imageUrl; // Update dengan URL baru
                    } else {
                        // Pertahankan URL lama jika tidak ada file baru
                        updatedData.gambar = existingItem.gambar;
                    }

                    // PERBAIKAN: Panggil update, TAPI JANGAN update cache lokal secara manual
                    await updateItem(id, updatedData);
                    logActivity('Update Data Barang', updatedData.kode);
                } else {
                    // ADD NEW
                    if (imageUrl !== undefined) {
                        itemData.gambar = imageUrl;
                    }

                    // PERBAIKAN: Panggil add, TAPI JANGAN update cache lokal secara manual
                    await addItem(itemData);
                    logActivity('Tambah Barang Baru', itemData.kode);
                }

                // PERBAIKAN: Hapus render manual. Biarkan realtime listener yang bekerja.
                // renderAdminList();
                // renderOperatorList();

                // CUKUP reset form dan tutup form otomatis
                resetForm();
                toggleAdminForm(false);

                // Scroll kembali ke dashboard (item list)
                if (itemListContainer) {
                    itemListContainer.scrollIntoView({ behavior: 'smooth' });
                }

            } catch (error) {
                console.error("Gagal submit form:", error);
                showConfirmation({ title: 'Error', message: `Gagal menyimpan: ${error.message}`, okText: 'OK' });
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Simpan';
            }
        }

        function handleEditClick(btn) {
            // Auto open form
            toggleAdminForm(true);

            const id = btn.dataset.id;
            // Bandingkan sebagai string karena dataset selalu string
            const item = items.find(i => i.id.toString() === id);

            if (item) {
                document.getElementById('item-id').value = item.id;
                document.getElementById('kode-barang').value = item.kode;
                document.getElementById('nama-barang').value = item.nama;
                document.getElementById('permasalahan').value = item.masalah;
                imagePreview.src = item.gambar || '';
                imagePreview.classList.toggle('hidden', !item.gambar);
                imageInput.value = ''; // Hapus file input sebelumnya
                formTitle.textContent = "Edit Data Barang";
                submitBtn.textContent = "Update";
                cancelEditBtn.classList.remove('hidden');
                // Scroll ke atas form
                itemForm.scrollIntoView({ behavior: 'smooth' });
            } else {
                // Ini adalah debug error dari sebelumnya
                showConfirmation({ title: 'Debug Error', message: `Tombol Edit diklik (ID: ${id}), tapi data item tidak ditemukan di cache lokal. Coba refresh halaman.`, okText: 'OK' });
            }
        }

        function handleDeleteClick(btn) {
            const id = btn.dataset.id;
            // Bandingkan sebagai string
            const item = items.find(i => i.id.toString() === id);

            if (item) {
                showConfirmation({
                    title: 'Hapus Barang',
                    message: `Anda yakin ingin menghapus data untuk "${item.nama}" (Kode: ${item.kode})?`,
                    okText: 'Ya, Hapus',
                    okClass: 'bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700',
                    onOk: () => deleteItem(item), // Kirim seluruh objek item
                    onCancel: () => { }
                });
            } else {
                // Ini adalah debug error dari sebelumnya
                showConfirmation({ title: 'Debug Error', message: `Tombol Hapus diklik (ID: ${id}), tapi data item tidak ditemukan di cache lokal. Coba refresh halaman.`, okText: 'OK' });
            }
        }

        function resetForm() {
            itemForm.reset();
            document.getElementById('item-id').value = '';
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
            formTitle.textContent = "Tambah Barang Baru";
            submitBtn.textContent = "Simpan";
            cancelEditBtn.classList.add('hidden');
        }

        function toggleAdminForm(show) {
            if (!adminFormContainer) return;
            if (show === undefined) show = adminFormContainer.classList.contains('hidden');

            if (show) {
                adminFormContainer.classList.remove('hidden');
                if (toggleFormIcon) {
                    toggleFormIcon.classList.replace('fa-plus', 'fa-minus');
                    toggleFormIcon.classList.add('rotate-180');
                }
                if (toggleFormText) toggleFormText.textContent = 'Tutup Formulir';
                if (toggleFormBtn) {
                    toggleFormBtn.classList.replace('bg-indigo-600', 'bg-slate-600');
                    toggleFormBtn.classList.replace('hover:bg-indigo-700', 'hover:bg-slate-700');
                }
            } else {
                adminFormContainer.classList.add('hidden');
                if (toggleFormIcon) {
                    toggleFormIcon.classList.replace('fa-minus', 'fa-plus');
                    toggleFormIcon.classList.remove('rotate-180');
                }
                if (toggleFormText) toggleFormText.textContent = 'Tambah Data Barang';
                if (toggleFormBtn) {
                    toggleFormBtn.classList.replace('bg-slate-600', 'bg-indigo-600');
                    toggleFormBtn.classList.replace('hover:bg-slate-700', 'hover:bg-indigo-700');
                }
                resetForm();
            }
        }

        // --- INITIALIZATION ---
        async function init() {
            // Cek apakah ada session admin tersimpan
            const isAdminLoggedIn = localStorage.getItem('isAdminSession') === 'true';

            // Tampilan default
            if (isAdminLoggedIn) {
                showView('admin');
                userRole = 'Admin'; // Update variable global langsung sebelum inisialisasi presence
            } else {
                showView('operator');
            }

            // Tombol Peran (disembunyikan, tapi logikanya ada)
            adminRoleBtn.addEventListener('click', () => {
                showPasswordModal(); // Tampilkan prompt password
            });
            operatorRoleBtn.addEventListener('click', () => showView('operator'));

            // Tombol Logout
            adminLogoutBtn.addEventListener('click', () => {
                showConfirmation({
                    title: 'Konfirmasi Keluar',
                    message: 'Apakah Anda yakin ingin keluar dari Dashboard Admin?',
                    okText: 'Ya, Keluar',
                    okClass: 'bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700',
                    onOk: () => {
                        localStorage.removeItem('isAdminSession');
                        showView('operator');
                        updateRole('Operator');
                    },
                    onCancel: () => { } // Menambahkan fungsi kosong agar tombol Batal muncul
                });
            });
            // Tombol Logout / Refresh (Operator)
            const operatorRefreshBtn = document.getElementById('operator-refresh-btn');
            if (operatorRefreshBtn) operatorRefreshBtn.addEventListener('click', clearSearch);

            // Tombol Menu (Operator)
            const menuBtnOperator = document.getElementById('menu-btn-operator');
            if (menuBtnOperator) menuBtnOperator.addEventListener('click', openMenu);

            // Tombol Menu Global (Admin)
            const menuBtnGlobalAdmin = document.getElementById('menu-btn-global-admin');
            if (menuBtnGlobalAdmin) menuBtnGlobalAdmin.addEventListener('click', openMenu);

            closeMenuBtn.addEventListener('click', closeMenu);
            menuOverlay.addEventListener('click', closeMenu);

            menuHomeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                showView('operator');
                clearSearch();
                closeMenu();
            });
            menuAdminBtn.addEventListener('click', (e) => {
                e.preventDefault();
                closeMenu();
                showPasswordModal();
            });

            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const pass = passwordInput.value;
                if (pass === 'shinpo01') {
                    localStorage.setItem('isAdminSession', 'true');
                    hidePasswordModal();
                    showView('admin');
                    updateRole('Admin');
                } else {
                    passwordError.classList.remove('hidden');
                }
            });
            passwordCancelBtn.addEventListener('click', hidePasswordModal);

            // Presence Modal Events
            if (trackingBtnAdmin) trackingBtnAdmin.addEventListener('click', () => togglePresenceModal(true));
            if (closePresenceBtn) closePresenceBtn.addEventListener('click', () => togglePresenceModal(false));
            if (tabOnline) tabOnline.addEventListener('click', () => switchTab('online'));
            if (tabHistory) tabHistory.addEventListener('click', () => switchTab('history'));

            presenceModal.addEventListener('click', (e) => {
                if (e.target === presenceModal.firstElementChild.parentElement) togglePresenceModal(false);
            });
            // Fix: close-presence-modal is inside a div, backdrop click needed correctly.
            presenceModal.querySelector('.absolute.inset-0').addEventListener('click', () => togglePresenceModal(false));

            // Form Admin
            itemForm.addEventListener('submit', handleFormSubmit);
            cancelEditBtn.addEventListener('click', resetForm);
            imageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imagePreview.src = event.target.result;
                        imagePreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.src = '';
                    imagePreview.classList.add('hidden');
                }
            });

            // TAMBAHKAN LISTENER GLOBAL DI SINI
            // Kita dengarkan di 'app' karena item-list-container mungkin tersembunyi
            document.getElementById('app').addEventListener('click', handleGlobalClick);

            // Pencarian Operator
            searchBtn.addEventListener('click', handleSearch);
            searchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') handleSearch();
            });

            // --- BARU: Tambah listener scroll untuk dots ---
            searchResultDiv.addEventListener('scroll', handleScrollUpdateDots);

            // Toggle Operator List
            const toggleOperatorBtn = document.getElementById('toggle-operator-list');
            const operatorListWrapper = document.getElementById('operator-item-list-wrapper');
            const toggleIconOperator = document.getElementById('toggle-icon-operator');

            if (toggleOperatorBtn) {
                const toggleHintOperator = document.getElementById('toggle-hint-operator');
                toggleOperatorBtn.addEventListener('click', () => {
                    const isHidden = operatorListWrapper.classList.contains('hidden');
                    if (isHidden) {
                        operatorListWrapper.classList.remove('hidden');
                        toggleIconOperator.classList.add('rotate-180');
                        if (toggleHintOperator) toggleHintOperator.innerHTML = '<span>Klik untuk menutup daftar</span> <i class="fa-solid fa-chevron-up text-[10px]"></i>';
                    } else {
                        operatorListWrapper.classList.add('hidden');
                        toggleIconOperator.classList.remove('rotate-180');
                        if (toggleHintOperator) toggleHintOperator.innerHTML = '<span>Klik untuk melihat semua data</span> <i class="fa-solid fa-arrow-pointer animate-bounce text-[10px]"></i>';
                    }
                });
            }







            if (toggleFormBtn) {
                toggleFormBtn.addEventListener('click', () => toggleAdminForm());
            }

            // --- Admin Search Logic ---
            if (searchInputAdmin) {
                searchInputAdmin.addEventListener('input', (e) => {
                    const query = e.target.value.trim().toLowerCase();

                    // Show/hide clear button
                    if (searchClearAdmin) {
                        searchClearAdmin.classList.toggle('hidden', !query);
                    }

                    if (!query) {
                        renderAdminList();
                        return;
                    }

                    const filtered = items.filter(item =>
                        (item.kode && item.kode.toLowerCase().includes(query)) ||
                        (item.nama && item.nama.toLowerCase().includes(query))
                    );
                    renderAdminList(filtered);
                });
            }

            if (searchClearAdmin) {
                searchClearAdmin.addEventListener('click', () => {
                    searchInputAdmin.value = '';
                    searchClearAdmin.classList.add('hidden');
                    renderAdminList();
                });
            }

            // --- Toggle Admin Items Visibility ---
            if (toggleAdminItemsBtn) {
                toggleAdminItemsBtn.addEventListener('click', () => {
                    const isHidden = adminItemsContent.classList.contains('hidden');
                    if (isHidden) {
                        adminItemsContent.classList.remove('hidden');
                        toggleAdminItemsIcon.classList.replace('fa-eye', 'fa-eye-slash');
                        toggleAdminItemsText.textContent = 'Sembunyikan Daftar';
                        toggleAdminItemsBtn.classList.replace('bg-indigo-600', 'bg-slate-100');
                        toggleAdminItemsBtn.classList.replace('text-white', 'text-slate-500');
                    } else {
                        adminItemsContent.classList.add('hidden');
                        toggleAdminItemsIcon.classList.replace('fa-eye-slash', 'fa-eye');
                        toggleAdminItemsText.textContent = 'Tampilkan Daftar';
                        toggleAdminItemsBtn.classList.replace('bg-slate-100', 'bg-indigo-600');
                        toggleAdminItemsBtn.classList.replace('text-slate-500', 'text-white');
                    }
                });
            }



            // Modal Gambar
            closeModalBtn.addEventListener('click', hideImageModal);
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) hideImageModal();
            });

            zoomInBtn.addEventListener('click', () => {
                currentZoom = Math.min(3, currentZoom + 0.2);
                modalImg.style.transform = `scale(${currentZoom})`;
            });
            zoomOutBtn.addEventListener('click', () => {
                currentZoom = Math.max(0.5, currentZoom - 0.2);
                modalImg.style.transform = `scale(${currentZoom})`;
            });

            // Inisialisasi Supabase
            if (SUPABASE_URL && SUPABASE_ANON_KEY) {
                try {
                    // Gunakan createClient dari objek global window.supabase
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                    connectionStatus.textContent = "Menghubungkan...";
                    connectionStatus.classList.add('text-yellow-400');

                    // Setup listener realtime
                    setupRealtimeListener(); // Ini akan memanggil fetchAllItems()
                    setupPresence(); // --- BARU: Inisialisasi Presence ---

                    connectionStatus.textContent = "Terhubung";
                    connectionStatus.classList.remove('text-yellow-400');
                    connectionStatus.classList.add('text-green-400');

                } catch (e) {
                    console.error("Supabase Initialization Error:", e);
                    const errorMsg = `<p class="text-red-500">Konfigurasi Supabase tidak valid: ${e.message}</p>`;
                    // PERBAIKAN: Sesuaikan warna teks error spinner admin
                    if (loadingSpinnerAdmin) {
                        loadingSpinnerAdmin.querySelector('p').classList.remove('text-slate-800'); // Hapus warna lama jika ada
                        loadingSpinnerAdmin.querySelector('p').classList.add('text-red-500'); // Tambah warna error
                        loadingSpinnerAdmin.querySelector('p').textContent = `Konfigurasi Supabase tidak valid: ${e.message}`;
                        if (loadingSpinnerAdmin.querySelector('.spinner')) loadingSpinnerAdmin.querySelector('.spinner').classList.add('hidden');
                    }
                    if (loadingSpinnerOperator) {
                        loadingSpinnerOperator.innerHTML = errorMsg;
                    }
                    connectionStatus.textContent = "Gagal terhubung";
                    connectionStatus.classList.add('text-red-400');
                }
            } else {
                console.warn("Mode Demo. Harap konfigurasi Supabase.");
                const demoMsg = `<p class="text-orange-500">Mode Demo. Harap konfigurasi Supabase.</p>`;
                // PERBAIKAN: Sesuaikan warna teks demo spinner admin
                if (loadingSpinnerAdmin) {
                    loadingSpinnerAdmin.querySelector('p').classList.remove('text-slate-800'); // Hapus warna lama jika ada
                    loadingSpinnerAdmin.querySelector('p').classList.add('text-orange-500'); // Tambah warna demo
                    loadingSpinnerAdmin.querySelector('p').textContent = `Mode Demo. Harap konfigurasi Supabase.`;
                    if (loadingSpinnerAdmin.querySelector('.spinner')) loadingSpinnerAdmin.querySelector('.spinner').classList.add('hidden');
                }
                if (loadingSpinnerOperator) {
                    loadingSpinnerOperator.innerHTML = demoMsg;
                }
                connectionStatus.textContent = "Mode Demo";
                connectionStatus.classList.add('text-orange-400');
            }
        }

        // Jalankan inisialisasi
        init();
    </script>

</body>

</html>
